Bootstrap: localimage
From: /mnt/guanli/kangkai/RIC/ubuntu_22.04.sif

%labels
    Author ricpipe
    Version v1.1-with-MathCDF
    Description RIC-seq pipeline with complete Perl modules including Math::CDF

%setup
    # Create directories inside the image
    mkdir -p $SINGULARITY_ROOTFS/RICseq_scripts_root
    mkdir -p $SINGULARITY_ROOTFS/mnt/software

%files
    # 1. Copy RICpipe-master to the image
    /mnt/guanli/kangkai/RIC/RICpipe-master/*  /mnt/RICseq_scripts_root/
    # 2. Critical fix: Copy all files from softwares directory (not the directory itself) to /mnt/software root
    /mnt/guanli/kangkai/RIC/softwares/*  /mnt/software/

%post
    export DEBIAN_FRONTEND=noninteractive
    ln -fs /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

    echo "======================================"
    echo "Step 1: Install Basic Packages"
    echo "======================================"
    apt update
    # Install basic tools + Perl + cpanminus (better module management tool)
    apt install -y \
        vim wget unzip zip \
        perl \
        build-essential \
        cpanminus \
        zlib1g-dev libssl-dev libffi-dev libbz2-dev \
        libreadline-dev libsqlite3-dev libncurses5-dev \
        liblzma-dev tk-dev uuid-dev \
        openjdk-11-jre-headless \
        python3-pip \
        locales \
        bzip2 \
        liblist-moreutils-perl

    dpkg-reconfigure -f noninteractive tzdata

    echo "======================================"
    echo "Step 2: Configure Python Symbolic Link"
    echo "======================================"
    ln -s /usr/bin/python3 /usr/bin/python
    python --version || echo "Python symbolic link created successfully"

    echo "======================================"
    echo "Step 3: Verify /mnt/software Directory"
    echo "======================================"
    echo "===== File list in /mnt/software inside the image ====="
    ls -l /mnt/software/
    echo "======================================"

    echo "======================================"
    echo "Step 4: Install Perl Modules (Critical Step)"
    echo "======================================"

    # Configure CPAN to non-interactive mode
    (echo y; echo o conf prerequisites_policy follow; echo o conf commit) | cpan

    # Install core modules using cpanm (more stable)
    echo ">>> Installing core Perl modules..."
    cpanm --notest \
        List::Util \
        File::Spec \
        File::Basename \
        Getopt::Long \
        Cwd

    # Install Graph module (includes Graph::Undirected)
    echo ">>> Installing Graph::Undirected..."
    cpanm --notest Graph

    # [CRITICAL] Install Math::CDF and its dependencies
    echo ">>> Installing Math::CDF (critical module)..."
    # Install dependencies first
    cpanm --notest Statistics::Distributions
    # Then install Math::CDF
    cpanm --notest Math::CDF

    # Verify critical module installation
    echo "======================================"
    echo "Verifying Perl module installation..."
    echo "======================================"

    perl -e "use Graph::Undirected; print 'Graph::Undirected: OK\n'" || echo "❌ Graph::Undirected installation failed"
    perl -e "use List::MoreUtils; print 'List::MoreUtils: OK\n'" || echo "❌ List::MoreUtils installation failed"
    perl -e "use Math::CDF; print 'Math::CDF: OK\n'" || echo "❌ Math::CDF installation failed"
    perl -e "use Statistics::Distributions; print 'Statistics::Distributions: OK\n'" || echo "❌ Statistics::Distributions installation failed"

    # Functional testing
    echo ">>> Math::CDF functional test..."
    perl -MMath::CDF -e 'use Math::CDF; my $p = Math::CDF::pnorm(0); print "pnorm(0) = $p\n";' || echo "❌ Math::CDF functional test failed"

    echo "======================================"
    echo "Perl module installation complete!"
    echo "======================================"

    echo "======================================"
    echo "Step 5: Install Bioinformatics Tools"
    echo "======================================"

    ########## FastQC Installation
    echo ">>> Installing FastQC..."
    cd /mnt/software
    unzip -o fastqc_v0.12.1.zip
    chmod +x /mnt/software/FastQC/fastqc
    echo 'export PATH=/mnt/software/FastQC:$PATH' >> /environment

    ########## STAR Installation
    echo ">>> Installing STAR..."
    cd /mnt/software
    tar -zxvf 2.7.11b.tar.gz
    cd STAR-2.7.11b/source
    make
    echo 'export PATH=/mnt/software/STAR-2.7.11b/source:$PATH' >> /environment

    ########## SAMtools Installation
    echo ">>> Installing SAMtools..."
    cd /mnt/software
    tar -jxvf samtools-1.22.1.tar.bz2
    cd samtools-1.22.1
    ./configure
    make
    make install
    echo 'export PATH=/mnt/software/samtools-1.22.1:$PATH' >> /environment

    ########## BEDtools Installation
    echo ">>> Installing BEDtools..."
    cd /mnt/software
    tar -zxvf bedtools-2.28.0.tar.gz
    cd bedtools2
    make
    echo 'export PATH=/mnt/software/bedtools2/bin:$PATH' >> /environment

    ########## Trimmomatic Installation
    echo ">>> Installing Trimmomatic..."
    cd /mnt/software
    unzip -o Trimmomatic-0.36.zip
    ln -s /mnt/software/Trimmomatic-0.36/trimmomatic-0.36.jar /usr/local/bin/
    echo 'export PATH=/mnt/software/Trimmomatic-0.36:$PATH' >> /environment

    ########## cutadapt Installation
    echo ">>> Installing cutadapt..."
    pip3 install --upgrade pip
    pip3 install cutadapt==3.4
    # New addition: Install MultiQC (specify stable version 1.19, can be adjusted as needed)
    pip3 install multiqc==1.19
    echo 'export PATH=/usr/local/bin:$PATH' >> /environment

    ########## Locale Configuration
    echo "======================================"
    echo "Step 6: Configure Locale"
    echo "======================================"
    echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
    locale-gen en_US.UTF-8
    update-locale LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8

    echo "======================================"
    echo "Container build complete!"
    echo "======================================"

%environment
    export LC_ALL=en_US.UTF-8
    export LANG=en_US.UTF-8
    export PATH=/mnt/software/FastQC:/mnt/software/STAR-2.7.11b/source:/mnt/software/samtools-1.22.1:/mnt/software/bedtools2/bin:/mnt/software/Trimmomatic-0.36:/usr/local/bin:$PATH
    # Perl module path
    export PERL5LIB=/usr/local/lib/x86_64-linux-gnu/perl/5.34.0:/usr/local/share/perl/5.34.0:$PERL5LIB

%runscript
    exec /bin/bash "$@"

%test
    # Container test script
    echo "======================================"
    echo "Container Test"
    echo "======================================"

    # Test bioinformatics tools
    echo ">>> Testing bioinformatics tools..."
    fastqc --version
    STAR --version
    samtools --version
    bedtools --version
    cutadapt --version

    # Test Perl modules
    echo ">>> Testing Perl modules..."
    perl -MMath::CDF -e 'print "Math::CDF: OK\n"'
    perl -MGraph::Undirected -e 'print "Graph::Undirected: OK\n"'
    perl -MList::MoreUtils -e 'print "List::MoreUtils: OK\n"'

    echo "======================================"
    echo "All tests passed!"
    echo "======================================"

%help
    RIC-seq analysis environment for Snakemake+Singularity
    Version: v1.1 with Math::CDF support

    Included tools:
    - FastQC (v0.12.1)
    - STAR (v2.7.11b)
    - SAMtools (v1.22.1)
    - BEDtools (v2.28.0)
    - Trimmomatic (v0.36)
    - cutadapt (v3.4)
    - MultiQC (v0.19)

    Included Perl modules:
    - Math::CDF ⭐ (for Step5 statistical analysis)
    - Statistics::Distributions
    - Graph::Undirected (for Step4 clustering)
    - List::MoreUtils
    - List::Util
    - File::Spec

    Usage examples:
      # Test tools
      singularity exec RIC-seq.sif fastqc --version
      singularity exec RIC-seq.sif STAR --version
      singularity exec RIC-seq.sif multiqc --help

      # Test Perl modules
      singularity exec RIC-seq.sif perl -MMath::CDF -e 'print "OK\n"'

      # Run pipeline
      snakemake -s RICseq.smk --use-singularity -j 16

